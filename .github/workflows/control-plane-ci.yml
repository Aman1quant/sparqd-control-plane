# -------------------------------------------------------
# CI Workflow
# - Runs on feature branches (feat/**, fix/**, etc.)
# - Runs on PRs into main
# - Purpose: run tests, lint, build checks
# - Does NOT deploy or push Docker images
# -------------------------------------------------------
name: control-plane-ci

on:
  workflow_dispatch:

  push:
    branches:
      - feat/**
      - fix/**
      - chore/**
      - refactor/**
      - docs/**
      - test/**
      - ci/**
      - perf/**
      - release/**
      - hotfix/**
    paths:
      - "control-plane/**"
      - ".github/workflows/control-plane-ci.yml"

  pull_request:
    branches:
      - main
    paths:
      - "control-plane/**"
      - ".github/workflows/control-plane-ci.yml"

env:
  AWS_REGION: ap-southeast-1                  # set this to your preferred AWS region, e.g. us-west-1
  ECR_REPOSITORY: sparqd/control-plane-api    # set this to your Amazon ECR repository name
  ARGO_REPO: sparqd/sparqd-control-plane-argocd

permissions:
  contents: read

jobs:
  test-and-build:
    environment: ${{ github.ref_name }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: control-plane

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      - name: Enable pnpm via corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install

      - name: Run build to check
        run: pnpm build
