datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  // output   = "app/generated/prisma/client"
}

// ============================================================================
//  Core Identity
// ============================================================================

model User {
  id        BigInt   @id @default(autoincrement()) // Internal only
  uid       String   @unique @default(uuid()) // Public-facing
  kcSub     String   @unique // Keycloak sub claim
  email     String   @unique
  fullName  String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts   AccountMember[] // many-to-many through AccountMember
  workspaces Workspace[] // for Workspace.createdBy
  invites    AccountInvite[] @relation("InvitedBy")

  auditLogs           AuditLog[]
  resourcePermissions ResourcePermission[]
  Resource            Resource[]

  @@map("users")
}

model Account {
  id        BigInt   @id @default(autoincrement())
  uid       String   @unique @default(uuid())
  name      String
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kcRealmStatus RealmStatus @default(CREATED)

  members    AccountMember[]
  invites    AccountInvite[]
  workspaces Workspace[]

  logs                AuditLog[]
  resourcePermissions ResourcePermission[]
  Resource            Resource[]

  @@map("accounts")
}

enum RealmStatus {
  CREATED
  FINALIZED
}

model Role {
  id          Int             @id @default(autoincrement())
  uid         String          @unique @default(uuid())
  name        String          @unique // match with Keycloak role name
  description String?
  members     AccountMember[]

  permissions         RolePermission[]
  resourcePermissions ResourcePermission[]

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  uid         String           @unique @default(uuid())
  action      String           @unique // e.g. 'project.read', 'project.update'
  description String?
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  uid          String     @unique @default(uuid())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  roleId       Int
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  permissionId Int

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================================================
//  Membership
// ============================================================================
model AccountInvite {
  id          BigInt    @id @default(autoincrement())
  uid         String    @unique @default(uuid())
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  accountId   BigInt
  email       String
  invitedBy   User?     @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedById BigInt?
  role        String    @default("member")
  token       String    @unique
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([accountId, email])
  @@map("account_invites")
}

model AccountMember {
  id        BigInt   @id @default(autoincrement())
  uid       String   @unique @default(uuid())
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  accountId BigInt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  userId    BigInt
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    Int // Foreign key to Role table
  joinedAt  DateTime @default(now())

  @@unique([accountId, userId])
  @@map("account_members")
}

// ============================================================================
//  Resource RBAC/ABAC
// ============================================================================
model Resource {
  id  BigInt @id @default(autoincrement())
  uid String @unique @default(uuid())

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId BigInt

  type        String // 'project', 'dataset', etc.
  targetId    BigInt // ID of the actual resource (e.g. project.id)
  name        String? // Optional — override or fallback name
  description String?
  metadata    Json?   @default("{}")

  createdBy   User?   @relation(fields: [createdById], references: [id])
  createdById BigInt?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions ResourcePermission[]

  @@unique([type, targetId])
  @@map("resources")
}

model ResourcePermission {
  id  BigInt @id @default(autoincrement())
  uid String @unique @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId BigInt

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId BigInt

  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  // ABAC, AWS IAM-like
  resourceType String // e.g. 'project', 'data'
  resourceId   BigInt? // optional — fallback if you match by name
  resourceName String? // e.g., 'project:my-project' or 's3://bucket/data/*'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Resource Resource? @relation(fields: [resourceId], references: [id])

  @@map("resource_permissions")
}

// ============================================================================
//  Business Resources
// ============================================================================

model Workspace {
  id          BigInt   @id @default(autoincrement())
  uid         String   @unique @default(uuid())
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade) // TODO: check Cascade or not
  accountId   BigInt
  name        String
  description String?
  metadata    Json?    @default("{}")
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById BigInt?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("workspaces")
}

// ============================================================================
//  Business Resources
// ============================================================================

model AuditLog {
  id           BigInt   @id @default(autoincrement())
  uid          String   @unique @default(uuid())
  account      Account  @relation(fields: [accountId], references: [id], onDelete: SetNull)
  accountId    BigInt
  accountName  String? // ← snapshot at log time   
  user         User?    @relation(fields: [userId], references: [id])
  userId       BigInt?
  userEmail    String? // ← snapshot at log time
  action       String
  resourceType String?
  resourceId   BigInt?
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now())

  @@map("audit_logs")
}
